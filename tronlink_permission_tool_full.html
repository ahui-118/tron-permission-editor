<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>TRON å¤šç­¾æƒé™ç®¡ç†å·¥å…·ï¼ˆå®Œæ•´ç‰ˆï¼‰</title>
  <script src="https://cdn.jsdelivr.net/npm/@tronweb3/tronwallet-adapter-tronlink"></script>
  <script src="https://cdn.jsdelivr.net/npm/tronweb@4.4.0/dist/TronWeb.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    textarea, pre { width: 100%; font-family: monospace; }
    textarea { height: 150px; }
    button { margin-top: 10px; }
    input[type="text"], input[type="number"] { width: 100%; margin-bottom: 0.5em; padding: 5px; }
    .section { margin-bottom: 2em; }
  </style>
</head>
<body>
  <h1>ğŸ” TRON å¤šç­¾æƒé™ç®¡ç†å·¥å…·ï¼ˆå…¨åŠŸèƒ½ï¼‰</h1>

  <!-- é“¾æ¥é’±åŒ… -->
  <div class="section">
    <button id="connectBtn">è¿æ¥ TronLink é’±åŒ…</button>
    <p id="walletAddress">é’±åŒ…æœªè¿æ¥</p>
  </div>

  <!-- æƒé™ç»“æ„å¯¼å…¥ -->
  <div class="section">
    <h3>ğŸ“¥ å¯¼å…¥æƒé™ç»“æ„ JSON</h3>
    <input type="file" id="jsonFile" accept=".json">
    <pre id="jsonPreview">å°šæœªå¯¼å…¥æƒé™ç»“æ„</pre>
  </div>

  <!-- æƒé™ç»“æ„ç¼–è¾‘å™¨ -->
  <div class="section">
    <h3>ğŸ§¾ ç¼–è¾‘æƒé™ç»“æ„</h3>
    <label>é˜ˆå€¼ï¼ˆThresholdï¼‰:</label>
    <input type="number" id="threshold" min="1" value="2">
    <label>ç­¾ååœ°å€åˆ—è¡¨ï¼ˆæ¯è¡Œä¸€ä¸ª T åœ°å€ï¼‰:</label>
    <textarea id="addressList" placeholder="T..."></textarea>
    <button onclick="buildStructure()">ç”Ÿæˆæƒé™ç»“æ„</button>
    <pre id="generatedJson"></pre>
  </div>

  <!-- ç­¾åäº¤æ˜“ -->
  <div class="section">
    <h3>ğŸ–‹ï¸ æƒé™æ›´æ–°äº¤æ˜“ç­¾åï¼ˆTronLink æˆ–ç§é’¥ï¼‰</h3>
    <button id="signBtn" disabled>ä½¿ç”¨ TronLink ç­¾åå¹¶å¹¿æ’­</button>
    <br><br>
    <label>æˆ–è¾“å…¥ç§é’¥ç­¾åï¼ˆä»…æœ¬åœ°ä½¿ç”¨ï¼‰:</label>
    <input type="text" id="privateKey" placeholder="ç§é’¥ hex">
    <button onclick="signWithPrivateKey()">ä½¿ç”¨ç§é’¥ç­¾åå¹¶å¹¿æ’­</button>
    <pre id="resultBox"></pre>
  </div>

  <!-- é“¾ä¸Šè¯»å– -->
  <div class="section">
    <h3>ğŸŒ æŸ¥çœ‹é“¾ä¸Šå½“å‰æƒé™ç»“æ„</h3>
    <button onclick="fetchPermissions()">è¯»å–å½“å‰æƒé™ç»“æ„</button>
    <pre id="onchainBox"></pre>
  </div>

<script>
  let tronWeb = null;
  let permissionJson = null;

  document.getElementById('connectBtn').onclick = async () => {
    if (window.tronLink) {
      await window.tronLink.request({ method: 'tron_requestAccounts' });
      tronWeb = window.tronWeb;
      document.getElementById('walletAddress').innerText = 'å½“å‰åœ°å€ï¼š' + tronWeb.defaultAddress.base58;
      if (permissionJson) document.getElementById('signBtn').disabled = false;
    } else {
      alert('è¯·å…ˆå®‰è£… TronLink æ’ä»¶');
    }
  };

  document.getElementById('jsonFile').addEventListener('change', async (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const text = await file.text();
    try {
      permissionJson = JSON.parse(text);
      document.getElementById('jsonPreview').textContent = JSON.stringify(permissionJson, null, 2);
      if (tronWeb) document.getElementById('signBtn').disabled = false;
    } catch (err) {
      document.getElementById('jsonPreview').textContent = 'âŒ æ— æ•ˆçš„ JSON æ–‡ä»¶';
    }
  });

  async function fetchPermissions() {
    try {
      const addr = tronWeb.defaultAddress.base58;
      const acc = await tronWeb.trx.getAccount(addr);
      document.getElementById('onchainBox').textContent = JSON.stringify(acc.owner_permission || {}, null, 2);
    } catch (e) {
      document.getElementById('onchainBox').textContent = 'âŒ è¯»å–å¤±è´¥: ' + e.message;
    }
  }

  function buildStructure() {
    const addrs = document.getElementById('addressList').value.trim().split(/\s+/);
    const threshold = parseInt(document.getElementById('threshold').value);
    const keys = addrs.map(addr => ({ address: addr, weight: 1 }));
    permissionJson = {
      owner: { permission_name: "owner", threshold, keys },
      actives: [
        {
          type: "Active",
          id: 2,
          permission_name: "active",
          threshold,
          operations: "7fff1fc0033ec30f000000000000000000000000000000000000000000000000",
          keys
        }
      ]
    };
    document.getElementById('generatedJson').textContent = JSON.stringify(permissionJson, null, 2);
    if (tronWeb) document.getElementById('signBtn').disabled = false;
  }

  document.getElementById('signBtn').onclick = async () => {
    try {
      const tx = await tronWeb.transactionBuilder.updateAccountPermissions(permissionJson, tronWeb.defaultAddress.base58);
      const signedTx = await tronWeb.trx.sign(tx);
      const result = await tronWeb.trx.sendRawTransaction(signedTx);
      document.getElementById('resultBox').textContent = JSON.stringify(result, null, 2);
    } catch (e) {
      document.getElementById('resultBox').textContent = 'âŒ é”™è¯¯: ' + e.message;
    }
  };

  async function signWithPrivateKey() {
    const privateKey = document.getElementById('privateKey').value.trim();
    if (!privateKey) return alert('è¯·è¾“å…¥ç§é’¥');
    try {
      const tronWebLocal = new TronWeb({ fullHost: 'https://api.trongrid.io', privateKey });
      const tx = await tronWebLocal.transactionBuilder.updateAccountPermissions(permissionJson, tronWebLocal.defaultAddress.base58);
      const signedTx = await tronWebLocal.trx.sign(tx);
      const receipt = await tronWebLocal.trx.sendRawTransaction(signedTx);
      document.getElementById('resultBox').textContent = JSON.stringify(receipt, null, 2);
    } catch (e) {
      document.getElementById('resultBox').textContent = 'âŒ é”™è¯¯: ' + e.message;
    }
  }
</script>
</body>
</html>
